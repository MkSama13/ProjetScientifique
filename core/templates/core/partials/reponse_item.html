{% load static %}
<div id="reponse-{{ reponse.pk }}" class="reponse-item flex flex-col gap-1 ml-16 group">
    <div class="flex items-start gap-3">
        <!-- Avatar (placeholder) -->
        <div class="w-8 h-8 rounded-full bg-blue-900 flex items-center justify-center text-base font-bold text-white shadow border-2 border-blue-400 select-none">
            {{ reponse.auteur.get_full_name|default:reponse.auteur.username|first|upper }}
        </div>
        <div class="flex-1">
            <div class="bg-white/10 rounded-2xl px-4 py-2 shadow border border-blue-400/10">
                <div class="flex items-center gap-2 mb-1">
                    <span class="font-semibold text-blue-200">{{ reponse.auteur.get_full_name|default:reponse.auteur.username }}</span>
                    <span class="text-xs text-gray-400">{{ reponse.date_reponse|date:'d/m/Y H:i' }}</span>
                </div>
                <div class="text-white text-base break-words">{{ reponse.contenu }}</div>
                {% if reponse.image or reponse.video or reponse.pdf %}
                <div class="flex flex-col gap-1 mt-2">
                    {% if reponse.image %}
                        <a href="{{ reponse.image.url }}" target="_blank" class="text-xs text-blue-300 hover:underline flex items-center gap-1">
                            <span>{{ reponse.image.name|slice:'reponses/images/' }}</span>
                            <span class="text-gray-400">[{{ reponse.image.name|cut:'.'|slice:'-3:'|upper }}]</span>
                        </a>
                    {% endif %}
                    {% if reponse.video %}
                        <a href="{{ reponse.video.url }}" target="_blank" class="text-xs text-pink-300 hover:underline flex items-center gap-1">
                            <span>{{ reponse.video.name|slice:'reponses/videos/' }}</span>
                            <span class="text-gray-400">[{{ reponse.video.name|cut:'.'|slice:'-3:'|upper }}]</span>
                        </a>
                    {% endif %}
                    {% if reponse.pdf %}
                        <a href="{{ reponse.pdf.url }}" target="_blank" class="text-xs text-red-400 hover:underline flex items-center gap-1">
                            <span>{{ reponse.pdf.name|slice:'reponses/pdfs/' }}</span>
                            <span class="text-gray-400">[PDF]</span>
                        </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="flex items-center gap-4 mt-1 ml-2">
                <span class="text-xs text-gray-400 font-semibold cursor-pointer hover:underline">J’aime</span>
                <span class="text-xs text-blue-400 font-semibold cursor-pointer hover:underline" onclick="toggleReponseFormReponse({{ reponse.pk }})">Répondre</span>
                {% if reponse.auteur == user %}
                <form method="POST" hx-post="{% url 'delete_reponse' reponse.pk %}" hx-target="#reponse-{{ reponse.pk }}" hx-swap="outerHTML" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="text-red-400 text-xs font-semibold cursor-pointer hover:underline bg-transparent border-0 p-0" style="background:none;">Supprimer</button>
                </form>
                {% endif %}
            </div>
            <!-- Formulaire de sous-réponse moderne -->
            <div id="reponse-form-reponse-{{ reponse.pk }}" class="hidden mt-2">
                <form method="post" enctype="multipart/form-data" hx-post="{% url 'add_reponse' reponse.commentaire.pk %}" hx-target="#reponses-list-reponse-{{ reponse.pk }}" hx-swap="afterbegin" class="flex items-center gap-2 bg-white/10 rounded-xl px-3 py-2 mt-1">
                    {% csrf_token %}
                    <input type="hidden" name="parent" value="{{ reponse.pk }}" />
                    <textarea name="contenu" rows="1" maxlength="300" placeholder="Répondre à {{ reponse.auteur.get_full_name|default:reponse.auteur.username }}..." class="flex-1 bg-transparent text-white border-0 focus:ring-0 focus:outline-none resize-none"></textarea>
                    <label class="cursor-pointer" title="Ajouter une image">
                        <svg class="w-5 h-5 text-blue-400 hover:text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a4 4 0 004 4h10a4 4 0 004-4V7a4 4 0 00-4-4H7a4 4 0 00-4 4z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11l2 2 4-4m2 6h.01" /></svg>
                        <input type="file" name="image" accept="image/*" class="hidden" />
                    </label>
                    <label class="cursor-pointer" title="Ajouter une vidéo">
                        <svg class="w-5 h-5 text-pink-400 hover:text-pink-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M4 6h8a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2z" /></svg>
                        <input type="file" name="video" accept="video/*" class="hidden" />
                    </label>
                    <label class="cursor-pointer" title="Ajouter un PDF">
                        <svg class="w-5 h-5 text-red-400 hover:text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /><rect width="20" height="20" x="2" y="2" rx="2" fill="none" /></svg>
                        <input type="file" name="pdf" accept="application/pdf" class="hidden" />
                    </label>
                    <button type="submit" class="ml-2 bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-1 rounded-lg text-xs">Publier</button>
                </form>
            </div>
            <!-- Réponses imbriquées -->
            <div id="reponses-list-reponse-{{ reponse.pk }}" class="mt-2">
                {% for rep in reponse.reponses.all %}
                    {% include 'core/partials/reponse_item.html' with reponse=rep user=user %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<script>
function toggleReponseFormReponse(reponseId) {
    const form = document.getElementById('reponse-form-reponse-' + reponseId);
    if (form) form.classList.toggle('hidden');
}
if (window.htmx) {
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        if (evt.detail.xhr && evt.detail.xhr.status === 204 && evt.target.classList.contains('reponse-item')) {
            evt.detail.shouldSwap = false;
            evt.target.style.transition = 'opacity 0.4s';
            evt.target.style.opacity = 0;
            setTimeout(function() {
                evt.target.remove();
            }, 400);
        }
        if (evt.detail.target && evt.detail.target.id && evt.detail.target.id.startsWith('reponses-list-reponse-')) {
            const reponseId = evt.detail.target.id.replace('reponses-list-reponse-', '');
            const form = document.getElementById('reponse-form-reponse-' + reponseId);
            if (form) form.classList.add('hidden');
        }
    });
}
</script>
