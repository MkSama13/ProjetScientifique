<!--
    Partial : commentaire_item.html
    Affiche un commentaire et ses réponses associées.
    - Affiche l'auteur, la date, le contenu du commentaire.
    - Permet de répondre à un commentaire (formulaire dynamique).
    - Permet à l'auteur de supprimer son commentaire (HTMX).
    - Affiche récursivement les réponses via le partial reponse_item.html.
-->
<div id="comment-{{ commentaire.pk }}" class="commentaire-item flex flex-col gap-1 mb-4 group">
    <div class="flex items-start gap-3">
        <!-- Avatar (placeholder) -->
        <!-- Avatar supprimé -->
        <div class="flex-1">
            <div class="bg-white/10 rounded-2xl px-4 py-3 shadow border border-blue-400/10 bg-[#181f36]">
                <div class="flex items-center gap-2 mb-1">
                    <span class="font-semibold text-blue-200">{{ commentaire.auteur.get_full_name|default:commentaire.auteur.username }}</span>
                    <span class="text-xs text-gray-400">{{ commentaire.date_commentaire|date:'d/m/Y H:i' }}</span>
                </div>
                <div class="text-white text-base break-words">{{ commentaire.contenu }}</div>
                {% if commentaire.image or commentaire.video or commentaire.pdf %}
                <div class="flex flex-col gap-1 mt-2">
                    {% if commentaire.image %}
                        <a href="{{ commentaire.image.url }}" target="_blank" class="text-xs text-blue-300 hover:underline flex items-center gap-1">
                            <span>{{ commentaire.image.name|slice:'commentaires/images/' }}</span>
                            <span class="text-gray-400">[{{ commentaire.image.name|cut:'.'|slice:'-3:'|upper }}]</span>
                        </a>
                    {% endif %}
                    {% if commentaire.video %}
                        <a href="{{ commentaire.video.url }}" target="_blank" class="text-xs text-pink-300 hover:underline flex items-center gap-1">
                            <span>{{ commentaire.video.name|slice:'commentaires/videos/' }}</span>
                            <span class="text-gray-400">[{{ commentaire.video.name|cut:'.'|slice:'-3:'|upper }}]</span>
                        </a>
                    {% endif %}
                    {% if commentaire.pdf %}
                        <a href="{{ commentaire.pdf.url }}" target="_blank" class="text-xs text-red-400 hover:underline flex items-center gap-1">
                            <span>{{ commentaire.pdf.name|slice:'commentaires/pdfs/' }}</span>
                            <span class="text-gray-400">[PDF]</span>
                        </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="flex items-center gap-4 mt-1 ml-2">
                <span class="text-xs text-blue-400 font-semibold cursor-pointer hover:underline" onclick="toggleReponseForm({{ commentaire.pk }})">Répondre</span>
                {% if commentaire.auteur == user %}
                <form method="POST" hx-post="{% url 'delete_commentaire' commentaire.pk %}" hx-target="#comment-{{ commentaire.pk }}" hx-swap="outerHTML" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="text-red-400 text-xs font-semibold cursor-pointer hover:underline bg-transparent border-0 p-0" style="background:none;">Supprimer</button>
                </form>
                {% endif %}
            </div>
            <!-- Formulaire de réponse moderne -->
            <div id="reponse-form-{{ commentaire.pk }}" class="hidden mt-2">
                <form method="post" enctype="multipart/form-data" hx-post="{% url 'add_reponse' commentaire.pk %}" hx-target="#reponses-list-{{ commentaire.pk }}" hx-swap="afterbegin" class="flex items-end gap-2 w-full">
                    {% csrf_token %}
                    <!-- Avatar supprimé dans le formulaire de réponse -->
                    <div class="flex flex-col rounded-2xl px-4 pt-2 pb-1 border border-blue-400/10 bg-[#181f36] flex-1">
                        <textarea name="contenu" rows="1" maxlength="300" placeholder="Répondre à {{ commentaire.auteur.get_full_name|default:commentaire.auteur.username }}..." class="w-full bg-transparent text-gray-100 border-0 focus:ring-0 focus:outline-none resize-none placeholder:text-gray-400 text-base"></textarea>
                        <div class="flex items-center gap-3 mt-2">
                            <label class="cursor-pointer" title="Ajouter une image">
                                <svg class="w-6 h-6 text-blue-400 hover:text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a4 4 0 004 4h10a4 4 0 004-4V7a4 4 0 00-4-4H7a4 4 0 00-4 4z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11l2 2 4-4m2 6h.01" /></svg>
                                <input type="file" name="image" accept="image/*" class="hidden" />
                            </label>
                            <label class="cursor-pointer" title="Ajouter une vidéo">
                                <svg class="w-6 h-6 text-pink-400 hover:text-pink-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M4 6h8a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2z" /></svg>
                                <input type="file" name="video" accept="video/*" class="hidden" />
                            </label>
                            <label class="cursor-pointer" title="Ajouter un PDF">
                                <svg class="w-6 h-6 text-red-400 hover:text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /><rect width="20" height="20" x="2" y="2" rx="2" fill="none" /></svg>
                                <input type="file" name="pdf" accept="application/pdf" class="hidden" />
                            </label>
                            <button type="submit" class="ml-auto flex items-center justify-center bg-transparent border-0 p-0" style="background:none;">
                                <!-- Facebook-like paper plane icon -->
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-blue-500 hover:text-blue-700" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <!-- Bloc d'affichage des réponses façon Facebook -->
            {% with reponses=commentaire.reponses.all %}
            {% if reponses and reponses|length > 0 %}
                <div id="toggle-reponses-btn-{{ commentaire.pk }}" class="flex items-center gap-2 mt-2 cursor-pointer select-none text-xs text-blue-300 hover:underline font-semibold" onclick="toggleReponses('{{ commentaire.pk }}')">
                    <span id="reponse-count-{{ commentaire.pk }}">Voir les réponses</span>
                    <svg id="chevron-{{ commentaire.pk }}" class="w-4 h-4 ml-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
            {% endif %}
            {% endwith %}
            <!-- Réponses imbriquées masquées par défaut -->
            <div id="reponses-list-{{ commentaire.pk }}" class="mt-2 hidden">
                {% for reponse in commentaire.reponses.all %}
                    {% include 'core/partials/reponse_item.html' with reponse=reponse user=user %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<!-- Ligne de séparation stylée entre commentaires principaux et entre réponses de même niveau -->
<hr class="my-4 border-t-2 border-blue-900/40 shadow-sm rounded-full w-11/12 mx-auto" />
<style>
.commentaire-item {
    transition: box-shadow 0.2s, border-color 0.2s;
}
.commentaire-item:hover {
    box-shadow: 0 4px 24px 0 #2563eb22;
    border-color: #2563eb66;
}
.commentaire-item .text-white {
    word-break: break-word;
}
</style>
<script>
// Affiche/masque dynamiquement le formulaire de réponse à un commentaire
function toggleReponseForm(commentaireId) {
    const form = document.getElementById('reponse-form-' + commentaireId);
    if (form) form.classList.toggle('hidden');
}
function toggleReponses(commentaireId) {
    const list = document.getElementById('reponses-list-' + commentaireId);
    const chevron = document.getElementById('chevron-' + commentaireId);
    if (list) {
        list.classList.toggle('hidden');
        if (chevron) chevron.style.transform = list.classList.contains('hidden') ? '' : 'rotate(180deg)';
    }
}
// Met à jour dynamiquement le compteur de réponses après ajout via HTMX
if (window.htmx) {
    document.body.addEventListener('htmx:afterSwap', function(e) {
        // Vérifie si une réponse a été ajoutée dans la bonne liste
        if (e.detail.target && e.detail.target.id && e.detail.target.id.startsWith('reponses-list-')) {
            var commentaireId = e.detail.target.id.replace('reponses-list-', '');
            var list = document.getElementById('reponses-list-' + commentaireId);
            var countSpan = document.getElementById('reponse-count-' + commentaireId);
            if (list && countSpan) {
                var nb = list.querySelectorAll('.reponse-item').length;
                countSpan.textContent = 'Voir les réponses (' + nb + ')';
            }
        }
    });
}
</script>
